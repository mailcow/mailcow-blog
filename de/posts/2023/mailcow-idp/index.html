<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=de><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>üîíüîë External Identity Providers for User authentication - mailcow: dockerized - Blog</title><meta name=author content="Moohoo">
<meta name=author-link content="servercow.de"><meta name=description content="Moohoo - Gute Nachricht, Freunde!
Mit dem Nightly Branch ist es nun m√∂glich, einen externen Identity Provider als weitere Authentifizierungsquelle zu nutzen.
Daf√ºr nutzt die mailcow das OIDC Protokoll, um ausschlie√ülich Mailbox User zu authentifizieren.
Um das zu erm√∂glichen, haben wir ein paar √Ñnderungen an der Art und Weise vorgenommen, wie die Authentifizierung funktioniert.
Lasst uns mal dar√ºber sprechen, was sich ge√§ndert hat, was wir uns dabei gedacht haben und was wir in Zukunft noch hinzuf√ºgen m√∂chten."><meta name=keywords content="2023,nightly,ldap,single sign on,sso,keycloak,authentik,identity provider,oidc"><meta itemprop=name content="üîíüîë External Identity Providers for User authentication"><meta itemprop=description content="Moohoo - Gute Nachricht, Freunde!
Mit dem Nightly Branch ist es nun m√∂glich, einen externen Identity Provider als weitere Authentifizierungsquelle zu nutzen.
Daf√ºr nutzt die mailcow das OIDC Protokoll, um ausschlie√ülich Mailbox User zu authentifizieren.
Um das zu erm√∂glichen, haben wir ein paar √Ñnderungen an der Art und Weise vorgenommen, wie die Authentifizierung funktioniert.
Lasst uns mal dar√ºber sprechen, was sich ge√§ndert hat, was wir uns dabei gedacht haben und was wir in Zukunft noch hinzuf√ºgen m√∂chten."><meta itemprop=datePublished content="2023-08-09T10:24:31+02:00"><meta itemprop=dateModified content="2023-11-21T10:43:45+01:00"><meta itemprop=wordCount content="1604"><meta itemprop=image content="https://mailcow.email/images/cow_mailcow.svg"><meta itemprop=keywords content="2023,nightly,ldap,single sign on,sso,keycloak,authentik,identity provider,oidc,"><meta property="og:title" content="üîíüîë External Identity Providers for User authentication"><meta property="og:description" content="Moohoo - Gute Nachricht, Freunde!
Mit dem Nightly Branch ist es nun m√∂glich, einen externen Identity Provider als weitere Authentifizierungsquelle zu nutzen.
Daf√ºr nutzt die mailcow das OIDC Protokoll, um ausschlie√ülich Mailbox User zu authentifizieren.
Um das zu erm√∂glichen, haben wir ein paar √Ñnderungen an der Art und Weise vorgenommen, wie die Authentifizierung funktioniert.
Lasst uns mal dar√ºber sprechen, was sich ge√§ndert hat, was wir uns dabei gedacht haben und was wir in Zukunft noch hinzuf√ºgen m√∂chten."><meta property="og:type" content="article"><meta property="og:url" content="https://mailcow.email/de/posts/2023/mailcow-idp/"><meta property="og:image" content="https://mailcow.email/images/cow_mailcow.svg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-08-09T10:24:31+02:00"><meta property="article:modified_time" content="2023-11-21T10:43:45+01:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://mailcow.email/images/cow_mailcow.svg"><meta name=twitter:title content="üîíüîë External Identity Providers for User authentication"><meta name=twitter:description content="Moohoo - Gute Nachricht, Freunde!
Mit dem Nightly Branch ist es nun m√∂glich, einen externen Identity Provider als weitere Authentifizierungsquelle zu nutzen.
Daf√ºr nutzt die mailcow das OIDC Protokoll, um ausschlie√ülich Mailbox User zu authentifizieren.
Um das zu erm√∂glichen, haben wir ein paar √Ñnderungen an der Art und Weise vorgenommen, wie die Authentifizierung funktioniert.
Lasst uns mal dar√ºber sprechen, was sich ge√§ndert hat, was wir uns dabei gedacht haben und was wir in Zukunft noch hinzuf√ºgen m√∂chten."><meta name=twitter:site content="@mailcow_email"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=https://mailcow.email/de/posts/2023/mailcow-idp/><link rel=prev href=https://mailcow.email/de/posts/2023/arm64-open-beta/><link rel=next href=https://mailcow.email/de/posts/2023/release-2023-09/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"üîíüîë External Identity Providers for User authentication","inLanguage":"de","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/mailcow.email\/de\/posts\/2023\/mailcow-idp\/"},"genre":"posts","keywords":"2023, nightly, ldap, single sign on, sso, keycloak, authentik, identity provider, oidc","wordcount":1604,"url":"https:\/\/mailcow.email\/de\/posts\/2023\/mailcow-idp\/","datePublished":"2023-08-09T10:24:31+02:00","dateModified":"2023-11-21T10:43:45+01:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Patrick Schult/FreddleSpl0it"},"description":""}</script></head><body data-header-desktop=fixed data-header-mobile=fixed><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper><div class=header-title><a href=/de/ title="mailcow: dockerized - Blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/cow_mailcow.svg data-srcset="/images/cow_mailcow.svg, /images/cow_mailcow.svg 1.5x, /images/cow_mailcow.svg 2x" data-sizes=auto alt="mailcow: dockerized - Blog" title="mailcow: dockerized - Blog"><span class=header-title-text>mailcow: dockerized - Blog</span><span class=header-title-post>üì∞</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/de/posts/>Beitr√§ge</a></li><li class=menu-item><a class=menu-link href=/de/tags/>Tags</a></li><li class=menu-item><a class=menu-link href=/de/categories/>Kategorien</a></li><li class=menu-item><a class=menu-link href=https://mailcow.github.io/mailcow-dockerized-docs/de rel="noopener noreferrer" target=_blank><i class='fa fa-book'></i> Dokumentation</a></li><li class=menu-item><a class=menu-link href=https://www.eth-services.de/ssd-vps/ rel="noopener noreferrer" target=_blank><i class='fa fa-server'></i> VPS</a></li><li class=menu-item><a class=menu-link href=https://www.servercow.de/mailcow#support title="Support erhalten" rel="noopener noreferrer" target=_blank><i class='fas fa-band-aid'></i> Support</a></li><li class=menu-item><a class=menu-link href=https://github.com/mailcow/mailcow-dockerized title=GitHub rel="noopener noreferrer" target=_blank><i class='fab fa-github fa-fw'></i> GitHub</a></li><li class="menu-item has-children"><a class=menu-link href=https://demo.mailcow.email title=Demos rel="noopener noreferrer" target=_blank><i class='fa fa-play'></i> Demos</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=https://demo.mailcow.email title="Stabile Demo" rel="noopener noreferrer" target=_blank>Stabile Demo</a></li><li class=menu-item><a class=menu-link href=https://nightly-demo.mailcow.email title="Nightly Demo" rel="noopener noreferrer" target=_blank>Nightly Demo</a></li></ul></li><li class="menu-item delimiter"></li><li class="menu-item language"><span role=button aria-label="Sprache w√§hlen" title="Sprache w√§hlen">Deutsch<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a href=/posts/2023/mailcow-idp/ class=menu-link title=English>English</a></li></ul></li><li class="menu-item theme-switch" title="Darstellung √§ndern"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/de/ title="mailcow: dockerized - Blog"><img class="lazyload logo" src=/svg/loading.min.svg data-src=/images/cow_mailcow.svg data-srcset="/images/cow_mailcow.svg, /images/cow_mailcow.svg 1.5x, /images/cow_mailcow.svg 2x" data-sizes=auto alt=/images/cow_mailcow.svg title=/images/cow_mailcow.svg><span class=header-title-text>mailcow: dockerized - Blog</span><span class=header-title-post>üì∞</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=menu-item><a class=menu-link href=/de/posts/>Beitr√§ge</a></li><li class=menu-item><a class=menu-link href=/de/tags/>Tags</a></li><li class=menu-item><a class=menu-link href=/de/categories/>Kategorien</a></li><li class=menu-item><a class=menu-link href=https://mailcow.github.io/mailcow-dockerized-docs/de rel="noopener noreferrer" target=_blank><i class='fa fa-book'></i> Dokumentation</a></li><li class=menu-item><a class=menu-link href=https://www.eth-services.de/ssd-vps/ rel="noopener noreferrer" target=_blank><i class='fa fa-server'></i> VPS</a></li><li class=menu-item><a class=menu-link href=https://www.servercow.de/mailcow#support title="Support erhalten" rel="noopener noreferrer" target=_blank><i class='fas fa-band-aid'></i> Support</a></li><li class=menu-item><a class=menu-link href=https://github.com/mailcow/mailcow-dockerized title=GitHub rel="noopener noreferrer" target=_blank><i class='fab fa-github fa-fw'></i> GitHub</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=https://demo.mailcow.email title=Demos rel="noopener noreferrer" target=_blank><i class='fa fa-play'></i> Demos</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=https://demo.mailcow.email title="Stabile Demo" rel="noopener noreferrer" target=_blank>Stabile Demo</a></li><li class=menu-item><a class=menu-link href=https://nightly-demo.mailcow.email title="Nightly Demo" rel="noopener noreferrer" target=_blank>Nightly Demo</a></li></ul></li><li class="menu-item theme-switch" title="Darstellung √§ndern"><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li><li class="menu-item language"><span role=button aria-label="Sprache w√§hlen" title="Sprache w√§hlen">Deutsch<i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i>
</span><select class=language-select onchange="location=this.value"><option value=/posts/2023/mailcow-idp/>English</option><option value=/de/posts/2023/mailcow-idp/ selected disabled>Deutsch</option></select></li></ul></nav></div></header><main class=container data-page-style=normal><aside class=toc id=toc-auto><h2 class=toc-title>Inhalt&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>üîíüîë External Identity Providers for User authentication</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/FreddleSpl0it title=Autor target=_blank rel="external nofollow noopener noreferrer author" class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
Patrick Schult/FreddleSpl0it</a></span>
<span class=post-category>enthalten in <a href=/de/categories/news/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> News</a></span></div><div class=post-meta-line><span title="2023-08-09 10:24:31"><i class="fa-regular fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=09.08.2023>09.08.2023</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw" aria-hidden=true></i> 1604 W√∂rter</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw" aria-hidden=true></i> 8 Minuten</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>Inhalt</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><ul><li><a href=#was-wurde-ge√§ndert-und-warum>Was wurde ge√§ndert und warum?</a><ul><li><a href=#mailcow-ui>mailcow UI</a></li><li><a href=#dovecot>Dovecot</a></li><li><a href=#sogo>SOGo</a></li><li><a href=#app-links>App-Links</a></li></ul></li><li><a href=#ideen-f√ºr-die-zukunft>Ideen f√ºr die Zukunft</a></li><li><a href=#wie-nutze-ich-dieses-feature>Wie nutze ich dieses Feature?</a><ul><li><a href=#keycloak-konfiguration>Keycloak Konfiguration</a><ul><li><a href=#schritt-1>Schritt 1</a></li><li><a href=#schritt-2>Schritt 2</a></li><li><a href=#schritt-3>Schritt 3</a></li><li><a href=#schritt-4>Schritt 4</a></li></ul></li><li><a href=#mailcow-konfiguration>mailcow Konfiguration</a><ul><li><a href=#schritt-1-1>Schritt 1</a></li><li><a href=#schritt-2-1>Schritt 2</a></li></ul></li><li><a href=#test-user-anlegen>Test User anlegen</a></li><li><a href=#idp-f√ºr-existierende-mailbox-user-√§ndern>IdP f√ºr existierende Mailbox User √§ndern</a></li><li><a href=#automatische-user-provisionierung>Automatische User Provisionierung</a><ul><li><a href=#schritt-1-2>Schritt 1</a></li><li><a href=#schritt-2-2>Schritt 2</a></li><li><a href=#schritt-3-1>Schritt 3</a></li><li><a href=#mailpassword-flow>Mailpassword Flow</a></li></ul></li><li><a href=#ldap>LDAP</a></li></ul></li><li><a href=#zum-schluss>Zum Schluss</a></li></ul></li></ul></nav></div></div><div class=content id=content><p><strong>Moohoo - Gute Nachricht, Freunde!</strong></p><p>Mit dem Nightly Branch ist es nun m√∂glich, einen externen Identity Provider als weitere Authentifizierungsquelle zu nutzen.<br>Daf√ºr nutzt die mailcow das OIDC Protokoll, um ausschlie√ülich Mailbox User zu authentifizieren.<br>Um das zu erm√∂glichen, haben wir ein paar √Ñnderungen an der Art und Weise vorgenommen, wie die Authentifizierung funktioniert.<br><br></p><p>Lasst uns mal dar√ºber sprechen, was sich ge√§ndert hat, was wir uns dabei gedacht haben und was wir in Zukunft noch hinzuf√ºgen m√∂chten. Nat√ºrlich zeigen wir euch auch, wie ihr das neue Feature nutzen k√∂nnt.<br>Um die Dinge zu vereinfachen, verwende ich im weiteren Beitrag die Abk√ºrzung <code>IdP</code> f√ºr Identity Provider<br><br><br></p><h3 id=was-wurde-ge√§ndert-und-warum>Was wurde ge√§ndert und warum?</h3><p>Unser Ziel war es, dass man neben der bestehenden SQL Datenbank, gleichzeitig einen IdP als Authentifizierungsquelle nutzen kann.
Dabei kann immer <strong>nur ein IdP</strong> konfiguriert werden und nicht mehrere.<br>Die mailcow muss jetzt also je nach User entscheiden k√∂nnen, welche Authentifizierungsquelle genutzt werden soll.
Um das zu erm√∂glichen, haben wir √Ñnderungen an den Diensten mailcow UI (phpfpm), Dovecot und SOGo vorgenommen.</p><h4 id=mailcow-ui>mailcow UI</h4><p>Die gesamte Logik zur Authentifizierung haben wir auf den phpfpm-Dienst ausgelagert.
F√ºr jeden User wird nun eine Authentifizierungsquelle hinterlegt, die zurzeit entweder mailcow, Keycloak oder Generic-OIDC sein kann.
Beim Login nutzt mailcow dann die entsprechende Quelle zur Authentifizierung.</p><h4 id=dovecot>Dovecot</h4><p>Dovecot hat bis jetzt ein custom LUA Script f√ºr die Authentifizierung genutzt, das SQL-Queries verwendet hat.
Statt SQL-Queries, werden nun HTTP-Requests zu einem intern verf√ºgbaren PHP-Script verwendet.<br>User die sich √ºber den IdP authentifizieren, <strong>m√ºssen App Passw√∂rter erstellen</strong>, damit weiterhin Mailclients wie Thunderbird genutzt werden k√∂nnen.<br>Es gibt noch eine weitere M√∂glichkeit, damit nicht extra App Passw√∂rter erstellt werden m√ºssen. Die steht allerdings nur f√ºr den Keycloak Provider zur Verf√ºgung.<br>Dazu komme ich aber sp√§ter.</p><h4 id=sogo>SOGo</h4><p>Viele haben sich vielleicht gefragt, warum der mailcow Login unter dem Root-Pfad angezeigt wird und nicht der SOGo Login.
F√ºr den SOGo Login existiert schon l√§nger ein Proxy Auth Feature, welches aus der mailcow UI genutzt werden kann.
Durch das Proxy Auth Feature k√∂nnen sich eingeloggte User zum SOGo weiterleiten lassen, ohne sich erneut anmelden zu m√ºssen.
Dadurch haben die User vorher noch die M√∂glichkeit, weitere Features zu nutzen, wie die Passwort√§nderung, App Passw√∂rter, tempor√§re Aliase, usw.
Damit das Feature mehr hervorgehoben wird, haben wir deswegen die mailcow UI √ºberarbeitet und einen auff√§lligen blauen Button direkt oben platziert, den wirklich niemand √ºbersehen sollte.
User, die den IdP nutzen, k√∂nnen sich nur √ºber die mailcow UI im SOGo einloggen. <strong>Ein direktes Einloggen √ºber SOGo funktioniert nicht.</strong></p><h4 id=app-links>App-Links</h4><p>Da ein direkter Login √ºber SOGo f√ºr IdP User nicht funktioniert, haben wir gleichzeitig die App-Links √ºberarbeitet, damit es in Zukunft nicht zu Verwirrung f√ºhrt.
App-Links k√∂nnen jetzt in den Einstellungen f√ºr den Login entweder versteckt oder angezeigt werden.
Die standardm√§√üige Verlinkung auf SOGo im mailcow Login wird versteckt. Eingeloggte User sehen jedoch weiterhin alle Apps.
Desweiteren kann man f√ºr eingeloggte User einen extra Link eintragen, wobei man hier mit <code>%u</code> eine Placeholder f√ºr den Usernamen hat.
Z.B. k√∂nnen eingeloggte User per App-Link so an das Proxy Auth Script mit <code>/sogo-auth.php?login=%u</code> weitergeleitet werden.<br><br></p><div style=text-align:center><img src=images/sso_mailcow5.png></div><br><br><br><h3 id=ideen-f√ºr-die-zukunft>Ideen f√ºr die Zukunft</h3><p>F√ºr die Zukunft k√∂nnten wir in Erw√§gung ziehen, dass ihr bei einzelnen Users einstellen k√∂nnt, wohin sie nach dem Login weitergeleitet werden sollen (mailcow oder SOGo).<br>Au√üerdem haben wir durch die √úberarbeitung der Authentifizierung die Login-Funktion in verschiedene Funktionen f√ºr Admins, Domain Admins, User und App-Passwort-Login aufgeteilt.
Wir k√∂nnten dar√ºber nachdenken, den Login f√ºr Admin, Domainadmin und User √ºber verschiedene Pfade bereitzustellen.
Daf√ºr m√ºssten wir dann aber auch die API in Admin-, Domainadmin- und User-API aufteilen.<br>Auf der Grundlage dieses Features k√∂nnten wir auch weitere OIDC-Provider hinzuf√ºgen, falls der Generic-OIDC-Provider nicht ausreicht oder sogar doch direkt einen LDAP Provider hinzuf√ºgen.<br><br><br></p><h3 id=wie-nutze-ich-dieses-feature>Wie nutze ich dieses Feature?</h3><p>Vorab m√∂chte ich erw√§hnen, dass wir in unseren Tests bisher nur Keycloak als IdP getestet haben. Dennoch ist es m√∂glich, auch andere IdP&rsquo;s (Generic-OIDC) einzurichten. Wenn ihr bereits einen anderen IdP wie zum Beispiel Authentik verwendet, w√ºrden wir uns √ºber Feedback freuen.<br><br></p><p>Die Voraussetzung f√ºr diese Anleitung ist, dass ihr bereits eine Keycloak-Instanz am Laufen habt.<br><br></p><p>F√ºr dieses Beispiel, nutzen wir folgendes Setup:</p><ul><li>Keycloak als IdP</li><li>Keycloak-Instanz ist unter <a href=https://mail.cow.tld/auth target=_blank rel="external nofollow noopener noreferrer">https://mail.cow.tld/auth</a> erreichbar</li><li>mailcow-Instanz ist unter <a href=https://mail.cow.tld target=_blank rel="external nofollow noopener noreferrer">https://mail.cow.tld</a> erreichbar</li><li>Als Domain f√ºr unsere E-Mails verwenden wir <code>cow.tld</code></li><li>In Keycloak nutzen wir <code>mailcow</code> als Realm.</li></ul><br><h4 id=keycloak-konfiguration>Keycloak Konfiguration</h4><h5 id=schritt-1>Schritt 1</h5><p>Installiert euch die mailcow Nightly Version auf einer Testinstanz.<br><a href=https://docs.mailcow.email/i_u_m/i_u_m_update/#best-practice-nightly-update target=_blank rel="external nofollow noopener noreferrer">https://docs.mailcow.email/i_u_m/i_u_m_update/#best-practice-nightly-update</a></p><h5 id=schritt-2>Schritt 2</h5><p>Logt euch als Admin in Keycloak ein und wechselt zu eurem Realm oder erstellt euch einen.<br>In dem Realm erstellen wir nun einen neuen Client namens <code>mailcow</code> und konfigurieren Ihn wie folgt:</p><div style="text-align:center;margin:30px 0"><img src=images/sso_keycloak1.png>
<img src=images/sso_keycloak2.png>
<img src=images/sso_keycloak3.png></div><h5 id=schritt-3>Schritt 3</h5><p>Nach dem speichern des Clients, m√ºssen wir f√ºr diesen noch ein User Attribute mit in den <code>token claim</code> aufnehmen. Das User Attribute nennt sich <code>mailcow_template</code> und durch folgende Einstellungen, wird dieses mit in den OIDC Endpoint <code>/userinfo</code> aufgenommen. Anhand dieses Attribute wird entschieden, wie die Mailbox konfiguriert wird (Quota, ACLs etc.)</p><div style="text-align:center;margin:30px 0"><img src=images/sso_keycloak4.png>
<img src=images/sso_keycloak5.png>
<img src=images/sso_keycloak6.png>
<img src=images/sso_keycloak7.png></div><h5 id=schritt-4>Schritt 4</h5><p>Nun k√∂nnen wir unter der Client Konfiguration den Client Secret kopieren und mit der mailcow weitermachen.</p><div style="text-align:center;margin:30px 0"><img src=images/sso_keycloak8.png></div><p><br><br><br></p><h4 id=mailcow-konfiguration>mailcow Konfiguration</h4><h5 id=schritt-1-1>Schritt 1</h5><p>Loggt euch in die mailcow ein und navigiert zu System -> Konfiguration -> Zugang -> Identity Provider. F√ºllt die Felder entsprechend aus.<br>Die Keycloak Version steht im Admin Dashboard unter dem master Realm. Hier ist es eigentlich nur wichtig zu wissen, ob eine Version gr√∂√üer oder kleiner 20 benutzt wird, da mailcow dementsprechen den &ldquo;openid&rdquo; scope hinzugef√ºgen muss.<br>Das Attribute Mapping ist daf√ºr da, dass mailcow anhand des Keycloak User Attributes <code>mailcow_template</code>, die entsprechend gemappte Mailbox Vorlage anwendet.
F√ºr das Beispiel habe ich keine extra Vorlage angelegt, weswegen wir ein Mapping auf die Default Vorlage einrichten.<br>Alles ab dem Attribute Mapping k√∂nnen wir erstmal ignorieren.</p><div style="text-align:center;margin:30px 0"><img src=images/sso_mailcow1.png></div><h5 id=schritt-2-1>Schritt 2</h5><p>Die Einstellungen k√∂nnen vor dem speichern getestet werden. Sollte der Test fehlschlagen, kontrolliert bitte, ob die mailcow die angegebene Server Url erreichen kann und die Angaben Realm, Client ID und Client Secret korrekt sind.</p><div style="text-align:center;margin:30px 0"><img src=images/sso_mailcow2.png></div><p><br><br><br></p><h4 id=test-user-anlegen>Test User anlegen</h4><p>Wir k√∂nnen jetzt hingehen und einen User in Keycloak hinzuf√ºgen. Wechselt daf√ºr wieder in das Keycloak Admin Dashboard und w√§hlt euren Realm aus.
Navigiert dann zu Users und f√ºgt den neuen User hinzu.</p><div style="text-align:center;margin:30px 0"><img src=images/sso_keycloak9.png></div><p>Danach geben wir noch an, dass der User eine <code>default mailbox</code> bekommt.</p><div style="text-align:center;margin:30px 0"><img src=images/sso_keycloak10.png>
<img src=images/sso_keycloak11.png></div><p>Zum Schluss nat√ºrlich noch dem neuen User unter dem <code>Credentials</code> Tab ein Passwort vergeben und fertig.<br></p><p>Der neue User existiert mit unserer jetzigen Konfiguration nicht direkt in mailcow. Dies geschieht aber automatisch beim ersten Login.
Navigiert zum mailcow Login und klickt auf den SSO Button im Dropdown. Dadurch werdet Ihr zu Keycloak weitergeleitet.
Sollte der Keycloak Login funktionieren und ihr landet trotzdem wieder bei dem mailcow Login mit einer Fehlermeldung, vergewissert euch bitte, dass die Domain existiert und das Mailboxen unter dieser Domain erstellt werden k√∂nnen.</p><div style="text-align:center;margin:30px 0"><img src=images/sso_mailcow3.png></div><p>Hat alles funktioniert, seid ihr nun eingeloggt und landet bei der neuen User Seite.
Ich denke den &ldquo;Login to webmail&rdquo; Button kann man schlecht √ºbersehen. Au√üerdem f√§llt auf, dass hier keine Konfigurationsm√∂glichkeiten f√ºr Passwort√§nderung oder 2FA angezeigt werden, da diese √ºber Keycloak konfiguriert werden.</p><div style="text-align:center;margin:30px 0"><img src=images/sso_mailcow4.png></div><p>Wenn Ihr mit diesem User nun einen Mailclient wie Thunderbird benutzen wollt, k√∂nnt Ihr euch unter <code>App Passwords</code> entsprechend ein Passwort erstellen.</p><p><br><br><br></p><h4 id=idp-f√ºr-existierende-mailbox-user-√§ndern>IdP f√ºr existierende Mailbox User √§ndern</h4><p>Ihr k√∂nnt den IdP f√ºr die bestehenden Mailbox User ganz einfach √§ndern. Ihr m√ºsst nur sicherstellen, dass der User im IdP existiert, dann die Mailbox in mailcow bearbeiten und den gew√ºnschten IdP ausw√§hlen. Wenn ihr sp√§ter wieder zu mailcow als IdP zur√ºckwechselt, wird das alte Passwort wiederverwendet.</p><div style="text-align:center;margin:30px 0"><img src=images/sso_mailcow6.png></div><p><br><br><br></p><h4 id=automatische-user-provisionierung>Automatische User Provisionierung</h4><p>Keycloak als IdP kann in der mailcow auch so konfiguriert werden, dass in einem benutzerdefinierten Intervall √Ñnderungen aller User kontrolliert werden.
Damit k√∂nnen User automatisch angelegt werden und selbst bei nachtr√§glichen √Ñnderungen des <code>mailcow_template</code>, Attribute automatisch angepasst werden.
Um das ganze konfigurieren zu k√∂nnen, ben√∂tigt der mailcow Client allerdings weitere Berechtigungen in Keycloak. Undzwar ben√∂tigt der Client die <code>view-users</code> Berechtigung.
Damit k√∂nnen √ºber die Keycloak Admin REST-API alle Realm User abgefragt werden.</p><h5 id=schritt-1-2>Schritt 1</h5><p>Loggt euch als Admin in Keycloak ein, wechselt zu eurem Realm und bearbeitet den mailcow Client.</p><div style=text-align:center><img src=images/sso_keycloak12.png>
<img src=images/sso_keycloak13.png></div><h5 id=schritt-2-2>Schritt 2</h5><p>Aktiviert in der mailcow UI unter Identity Provider <code>Periodic Full Sync</code> und <code>Import Users</code>. W√§hlt danach euren gew√ºnschten Intervall in Minuten und speichert.
<code>Periodic Full Sync</code> checkt, ob sich das <code>mailcow_template</code> Attribute ge√§ndert hat und passt die Mailbox dementsprechend an.
<code>Import Users</code> checkt, ob neue User erstellt wurden und erstellt diese ebenfalls in mailcow.</p><h5 id=schritt-3-1>Schritt 3</h5><p>Unter System -> Information -> Protokolle -> Crontasks landen alle Logs bzgl. der automatischen User Provisionierung.
Sollte also irgendwas nicht passen, findet ihr dort mehr Infos.</p><h5 id=mailpassword-flow>Mailpassword Flow</h5><p>Wie im Infotext unter der Option beschrieben, kann der Mailpassword Flow genutzt werden, um den User mittels des Keycloak Attribute <code>mailcow_password</code> zu authentifizieren.
Dieses Passwort kann auch direkt f√ºr die mailcow UI, sowie Mailclients verwendet werden.<br>Daf√ºr muss der mailcow Client die <code>view-users</code> Berechtigung haben, wie unter &mldr; beschrieben, und das Attribute <code>mailcow_password</code> muss in den <code>token claim</code> mit aufgenommen werden, wie unter &mldr; beschrieben.
Dem User kann in Keycloak nun das Attribute <code>mailcow_password</code> hinzugef√ºgt werden.
Das Passwort sollte gehashed werden und eines der folgenden Formate haben <a href=https://docs.mailcow.email/models/model-passwd/ target=_blank rel="external nofollow noopener noreferrer">https://docs.mailcow.email/models/model-passwd/</a>
Hier das Standard <code>moohoo</code> Passwort als Beispiel <code>{SSHA256}K8eVJ6YsZbQCfuJvSUbaQRLr0HPLz5rC9IAp0PAFl0tmNDBkMDc0NDAyOTAxN2Rk</code></p><p><br><br><br></p><h4 id=ldap>LDAP</h4><p>In Keycloak k√∂nnt ihr in eurem Realm unter <code>User Federation</code> ein LDAP Provider anbinden.<br><a href=https://www.keycloak.org/docs/latest/server_admin/#_ldap target=_blank rel="external nofollow noopener noreferrer">https://www.keycloak.org/docs/latest/server_admin/#_ldap</a><br><br>Nach dem konfigurieren muss noch das <code>mailcow_template</code> Attribute gemapped werden. Wenn gew√ºnscht, kann mit der gleichen Prozedur auch das <code>mailcow_password</code> Attribute mappen.<br>Mit der folgenden Konfiguration, mappen wir das LDAP Attribute <code>mailboxType</code> auf das Keycloak Attribute <code>mailcow_template</code>. Ist kein Wert vorhanden, forcieren wir <code>default</code> als Wert f√ºr <code>mailcow_template</code>.</p><div style=text-align:center><img src=images/sso_keycloak14.png>
<img src=images/sso_keycloak15.png></div><p><br><br><br></p><h3 id=zum-schluss>Zum Schluss</h3><p><strong>Die Authentifizierung wurde insgesamt stark ver√§ndert. Achtet beim Testen besonders auf Sicherheitsl√ºcken.</strong><br><strong>Ansonsten k√∂nnen wir sagen: Viel Spa√ü beim Testen! Wir freuen uns auf euer Feedback und eure Bug Reports.</strong><br><span style="font-size:3rem;margin:20px 0;display:block">üêÆ</span></p><br><hr><p>Bleibt gesund und happy Mailing!</p><p>Euer mailcow Team</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="2023-11-21 10:43:45">Aktualisiert am 21.11.2023&nbsp;</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/de/tags/2023/>2023</a>,&nbsp;<a href=/de/tags/nightly/>nightly</a>,&nbsp;<a href=/de/tags/ldap/>LDAP</a>,&nbsp;<a href=/de/tags/single-sign-on/>single sign on</a>,&nbsp;<a href=/de/tags/sso/>sso</a>,&nbsp;<a href=/de/tags/keycloak/>keycloak</a>,&nbsp;<a href=/de/tags/authentik/>authentik</a>,&nbsp;<a href=/de/tags/identity-provider/>identity provider</a>,&nbsp;<a href=/de/tags/oidc/>oidc</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Zur√ºck</a></span>&nbsp;|&nbsp;<span><a href=/de/>Startseite</a></span></section></div><div class=post-nav><a href=/de/posts/2023/arm64-open-beta/ class=prev rel=prev title="üí™üêÆ6Ô∏è‚É£4Ô∏è‚É£ mailcow: dockerized (ARM64) ist nun im Nightly Branch erh√§ltlich (Offene Beta)"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>üí™üêÆ6Ô∏è‚É£4Ô∏è‚É£ mailcow: dockerized (ARM64) ist nun im Nightly Branch erh√§ltlich (Offene Beta)</a>
<a href=/de/posts/2023/release-2023-09/ class=next rel=next title="üî•üêÑ Hotfix Update September 2023 (SOGo 5.9.0)">üî•üêÑ Hotfix Update September 2023 (SOGo 5.9.0)<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div></article></main><footer class=footer><div class=footer-container><div class="footer-line custom"><a href=/de/imprint/>Impressum</a> | <a href=/de/policy/>Datenschutz</div><div class="footer-line powered">Realisiert durch <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.120.4">Hugo</a> | Thema - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.16"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2016 - 2023</span><span class="license footer-divider"><a rel="license external nofollow noopener noreffer" href=https://tinc.gmbh?kontakt target=_blank>The Infrastructure Company GmbH</a></span></div><div class="footer-line statistics"></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label="Nach oben"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div></div><div id=mask></div><noscript><div class=noscript-warning>Theme FixIt works best with JavaScript enabled.</div></noscript></div><link rel=stylesheet href=/lib/katex/katex.min.css><script src=/lib/lazysizes/lazysizes.min.js async defer></script><script src=/lib/katex/katex.min.js defer></script><script src=/lib/katex/auto-render.min.js defer></script><script src=/lib/katex/copy-tex.min.js defer></script><script src=/lib/katex/mhchem.min.js defer></script><script>window.config={code:{copyTitle:"In Zwischenablage kopieren",editLockTitle:"Bearbeitbaren Codeblock sperren",editUnLockTitle:"Bearbeiten des Codeblocks entsperren",editable:!0,maxShownLines:10},comment:{enable:!1},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1}}</script><script src=/js/theme.min.js defer></script></body></html>